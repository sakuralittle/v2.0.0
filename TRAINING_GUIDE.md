# SAC æ¨¡åž‹è¨“ç·´æŒ‡å—

## æž¶æ§‹æ¦‚è¿°

è¨“ç·´ç³»çµ±å®Œå…¨åŸºæ–¼ backtrader å›žæ¸¬å¼•æ“Žï¼Œç¢ºä¿èˆ‡å¯¦éš›äº¤æ˜“ç’°å¢ƒä¸€è‡´ã€‚

### æ ¸å¿ƒçµ„ä»¶

1. **TrainingStrategy** - è¨“ç·´ç”¨ç­–ç•¥
   - æ§‹å»ºç‹€æ…‹å‘é‡ï¼ˆæŠ€è¡“æŒ‡æ¨™ï¼‰
   - ä½¿ç”¨ agent é¸æ“‡å‹•ä½œ
   - æ”¶é›†ç¶“é©— (s, a, r, s', done)
   - å­˜å„²åˆ° replay buffer
   - å®šæœŸè¨“ç·´ agent

2. **train_agent_indicator** - è¨“ç·´ç®¡ç†é¡ž
   - ç®¡ç† replay buffer
   - è¨ˆç®—çŽå‹µå‡½æ•¸
   - è¿½è¹¤è¨“ç·´çµ±è¨ˆ
   - ç®¡ç†æ¨¡åž‹ä¿å­˜

3. **agent_indicator** - æŽ¨ç†ç”¨æŒ‡æ¨™
   - åŠ è¼‰é è¨“ç·´æ¨¡åž‹
   - åƒ…ç”¨æ–¼å¯¦éš›äº¤æ˜“æŽ¨ç†

## è¨“ç·´æµç¨‹

### 1. è³‡æ–™æº–å‚™
```python
# è³‡æ–™è‡ªå‹•åˆ‡åˆ†ç‚ºè¨“ç·´é›†ã€é©—è­‰é›†ã€æ¸¬è©¦é›†
train_df, val_df, test_df = load_and_split_data(
    data_path,
    train_ratio=0.6,    # 60% è¨“ç·´
    val_ratio=0.2,      # 20% é©—è­‰
)
```

### 2. è¨“ç·´åŸ·è¡Œ
```bash
# ç›´æŽ¥åŸ·è¡Œè¨“ç·´
python train_1.py
```

### 3. è¨“ç·´éŽç¨‹

æ¯å€‹ episodeï¼š
1. å‰µå»ºæ–°çš„ cerebro å¯¦ä¾‹
2. æ·»åŠ  TrainingStrategy
3. é‡ç½® broker åˆ°åˆå§‹ç‹€æ…‹
4. åŸ·è¡Œå®Œæ•´çš„å›žæ¸¬
5. æ”¶é›†ç¶“é©—ä¸¦è¨“ç·´ agent
6. è¨˜éŒ„çµ±è¨ˆè³‡è¨Š

### 4. é€²åº¦é¡¯ç¤º

æ¯ 5 å€‹ episode é¡¯ç¤ºï¼š
- â±ï¸ æ™‚é–“çµ±è¨ˆï¼ˆå–® episode + ç¸½æ™‚é•·ï¼‰
- ðŸ“Š è¨“ç·´æ”¶ç›ŠçŽ‡
- ðŸ’° æœ€çµ‚è³‡é‡‘
- ðŸ—ƒï¸ Replay Buffer å¤§å°
- ðŸ“‰ å¹³å‡ Critic Loss
- âœ… é©—è­‰æ”¶ç›ŠçŽ‡

### 5. æ¨¡åž‹ä¿å­˜

- **æœ€ä½³æ¨¡åž‹**ï¼šé©—è­‰æ”¶ç›ŠçŽ‡æœ€é«˜æ™‚è‡ªå‹•ä¿å­˜åˆ° `models/sac_model.pth`
- **æª¢æŸ¥é»ž**ï¼šæ¯ 10 å€‹ episode ä¿å­˜åˆ° `models/sac_model_ep{N}.pth`

### 6. æ—©åœæ©Ÿåˆ¶

- é©—è­‰æ”¶ç›ŠçŽ‡ 20 å€‹ episode ç„¡æ”¹å–„ â†’ è‡ªå‹•åœæ­¢
- é”åˆ°ç›®æ¨™æ”¶ç›ŠçŽ‡ 20% â†’ è‡ªå‹•åœæ­¢

### 7. æ¸¬è©¦é›†è©•ä¼°

è¨“ç·´å®Œæˆå¾Œï¼Œè‡ªå‹•ä½¿ç”¨æ¸¬è©¦é›†è©•ä¼°æœ€ä½³æ¨¡åž‹ï¼š
- è¼‰å…¥æœ€ä½³æ¨¡åž‹ï¼ˆå¾žé©—è­‰é›†é¸å‡ºï¼‰
- åœ¨æ¸¬è©¦é›†ä¸ŠåŸ·è¡Œå›žæ¸¬
- é¡¯ç¤ºæœ€çµ‚æ”¶ç›ŠçŽ‡å’Œçµ±è¨ˆè³‡è¨Š
- **é€™æ˜¯æ¨¡åž‹çš„æœ€çµ‚æ€§èƒ½æŒ‡æ¨™**

## é…ç½®èªªæ˜Ž

### BROKER_CONFIG (æ–°å¢ž)
```python
{
    'initial_cash': 100000.0,   # åˆå§‹è³‡é‡‘
    'commission': 0.001,        # æ‰‹çºŒè²» 0.1%
}
```

### TRAIN_CONFIG
```python
{
    'episodes': 100,            # è¨“ç·´å›žåˆæ•¸
    'batch_size': 256,          # æ‰¹æ¬¡å¤§å°
    'replay_buffer_size': 100000,  # Buffer å®¹é‡
    'update_frequency': 1,      # æ¯æ­¥æ›´æ–°ç¶²çµ¡
    'start_steps': 1000,        # é–‹å§‹è¨“ç·´å‰çš„æŽ¢ç´¢æ­¥æ•¸
    'save_frequency': 10,       # ä¿å­˜é »çŽ‡
    'print_frequency': 5,       # æ‰“å°é »çŽ‡
    'early_stopping_patience': 20,  # æ—©åœè€å¿ƒå€¼
    'target_return': 0.2,       # ç›®æ¨™æ”¶ç›ŠçŽ‡ 20%
    'force_cuda': True,         # æ˜¯å¦å¼·åˆ¶ä½¿ç”¨ CUDA (GPU)
    'device': 'auto',           # è¨­å‚™é¸æ“‡: 'auto', 'cuda', 'cpu'
}
```

#### GPU / CPU é…ç½®

**å¼·åˆ¶ä½¿ç”¨ GPU è¨“ç·´** (æŽ¨è–¦ï¼Œè¨“ç·´é€Ÿåº¦å¿« 10-100 å€)ï¼š
```python
'force_cuda': True,    # GPU ä¸å¯ç”¨æ™‚å ±éŒ¯
'device': 'auto',      # è‡ªå‹•é¸æ“‡
```

**è‡ªå‹•é¸æ“‡è¨­å‚™** (GPU å„ªå…ˆï¼Œä¸å¯ç”¨å‰‡é™ç´šåˆ° CPU)ï¼š
```python
'force_cuda': False,
'device': 'auto',
```

**å¼·åˆ¶ä½¿ç”¨ CPU**ï¼š
```python
'force_cuda': False,
'device': 'cpu',
```

è¨“ç·´é–‹å§‹æ™‚æœƒé¡¯ç¤ºè¨­å‚™ä¿¡æ¯ï¼š
```
ðŸ–¥ï¸  è¨­å‚™é…ç½®:
  è¨­å‚™é¸é …: auto
  å¼·åˆ¶ä½¿ç”¨ CUDA: True
  CUDA å¯ç”¨: True
  GPU åž‹è™Ÿ: NVIDIA GeForce RTX 3080
  CUDA ç‰ˆæœ¬: 11.8
  âœ… ä½¿ç”¨è¨­å‚™: cuda:0
```

### DATA_CONFIG
```python
{
    'data_path': '...',         # è³‡æ–™è·¯å¾‘
    'train_ratio': 0.6,         # è¨“ç·´é›†æ¯”ä¾‹
    'val_ratio': 0.2,           # é©—è­‰é›†æ¯”ä¾‹
    'test_ratio': 0.2,          # æ¸¬è©¦é›†æ¯”ä¾‹
    'enable_validation': True,  # å•Ÿç”¨é©—è­‰
}
```

## çŽå‹µå‡½æ•¸è¨­è¨ˆ

```python
# ç•¶å‰å¯¦ä½œï¼šåŸºæ–¼å–®æ­¥æ”¶ç›ŠçŽ‡
reward = step_return * 100

# step_return è¨ˆç®—ï¼š
step_return = (current_value - previous_value) / previous_value

# current_value åŒ…å«ï¼š
# - ç¾é‡‘
# - æŒå€‰å¸‚å€¼ï¼ˆå«æœªå¯¦ç¾æç›Šï¼‰
```

### å¯è‡ªè¨‚çŽå‹µå‡½æ•¸

åœ¨ `train_agent_indicator.calculate_reward()` ä¸­ä¿®æ”¹ï¼š
- åŠ å…¥é¢¨éšªæ‡²ç½°ï¼ˆä¾‹å¦‚ï¼šæœ€å¤§å›žæ’¤ï¼‰
- åŠ å…¥äº¤æ˜“æˆæœ¬æ‡²ç½°
- åŠ å…¥æŒå€‰æ™‚é–“è€ƒé‡
- åŠ å…¥å¤æ™®æ¯”çŽ‡çŽå‹µ

## è¨“ç·´è¼¸å‡ºç¯„ä¾‹

```
======================================================================
é–‹å§‹è¨“ç·´ SAC æ¨¡åž‹
======================================================================
è³‡æ–™åˆ‡åˆ†:
  è¨“ç·´é›†: 12000 ç­† (2023-01-01 ~ 2023-08-15)
  é©—è­‰é›†: 4000 ç­† (2023-08-15 ~ 2023-11-01)
  æ¸¬è©¦é›†: 4000 ç­† (2023-11-01 ~ 2024-01-15)

[Episode 5/100]
  æ™‚é–“: 12.34s (ç¸½è¨ˆ: 1.02min)
  æ”¶ç›ŠçŽ‡: 3.45%
  æœ€çµ‚è³‡é‡‘: $103450.00
  Replay Buffer: 5234
  å¹³å‡ Critic Loss: 0.0234
  é©—è­‰æ”¶ç›ŠçŽ‡: 2.15%
  âœ“ ä¿å­˜æœ€ä½³æ¨¡åž‹ (é©—è­‰æ”¶ç›ŠçŽ‡: 2.15%)

[Episode 10/100]
  æ™‚é–“: 11.98s (ç¸½è¨ˆ: 2.01min)
  æ”¶ç›ŠçŽ‡: 4.12%
  æœ€çµ‚è³‡é‡‘: $104120.00
  Replay Buffer: 10468
  å¹³å‡ Critic Loss: 0.0198
  é©—è­‰æ”¶ç›ŠçŽ‡: 3.21%
  âœ“ ä¿å­˜æœ€ä½³æ¨¡åž‹ (é©—è­‰æ”¶ç›ŠçŽ‡: 3.21%)
  âœ“ ä¿å­˜æª¢æŸ¥é»ž: models/sac_model_ep10.pth

...

======================================================================
è¨“ç·´å®Œæˆï¼ç¸½æ™‚é–“: 25.34 åˆ†é˜
æœ€ä½³é©—è­‰æ”¶ç›ŠçŽ‡: 18.45%
æ¨¡åž‹å·²ä¿å­˜è‡³: models/sac_model.pth
======================================================================

======================================================================
é–‹å§‹æ¸¬è©¦æ¨¡åž‹
======================================================================
è¼‰å…¥æ¨¡åž‹: models/sac_model.pth

æ¸¬è©¦è³‡æ–™: 4000 ç­† (2023-11-01 ~ 2024-01-15)
åˆå§‹è³‡é‡‘: $100,000.00

======================================================================
æ¸¬è©¦çµæžœ
======================================================================
åˆå§‹è³‡é‡‘: $100,000.00
æœ€çµ‚è³‡é‡‘: $116,234.50
æ·¨åˆ©æ½¤:   $16,234.50
æ”¶ç›ŠçŽ‡:   16.23%
æ¸¬è©¦æ™‚é–“: 8.45s
======================================================================

======================================================================
è¨“ç·´èˆ‡æ¸¬è©¦æµç¨‹å®Œæˆï¼
======================================================================
âœ… æ¸¬è©¦é›†æ”¶ç›ŠçŽ‡: 16.23%
âœ… æ¨¡åž‹å·²ä¿å­˜è‡³: models/sac_model.pth
======================================================================
```

## èˆ‡ cerebro çš„äº’å‹•

### é—œéµç‰¹æ€§
âœ… **æ¯å€‹ episode éƒ½å‰µå»ºæ–°çš„ cerebro**
âœ… **broker ç‹€æ…‹å®Œå…¨é‡ç½®**
âœ… **ä½¿ç”¨çœŸå¯¦çš„ backtrader äº¤æ˜“é‚è¼¯**
âœ… **æ”¶ç›ŠçŽ‡åŒ…å«æ‰‹çºŒè²»å’Œæ»‘åƒ¹**
âœ… **æœªå¯¦ç¾æç›Šå¯¦æ™‚åæ˜ åœ¨çŽå‹µä¸­**

### ç‹€æ…‹æ§‹å»º
èˆ‡æŽ¨ç†æ™‚å®Œå…¨ä¸€è‡´ï¼š
- HullMA (mhull, shull, signal)
- RSI, CCI
- åƒ¹æ ¼è®ŠåŒ–çŽ‡ï¼ˆå‰ 5 æ ¹ K ç·šï¼‰
- æˆäº¤é‡ã€ç•¶å‰åƒ¹æ ¼
- Z-score æ­£è¦åŒ–

### å‹•ä½œåŸ·è¡Œ
- å‹•ä½œç¯„åœï¼š[-1, 1]
- > 0.5 â†’ è²·å…¥
- < -0.5 â†’ è³£å‡º
- å…¶ä»– â†’ æŒæœ‰

## å¾ŒçºŒæ“´å±•ï¼šWalk Forward

ç›®å‰æž¶æ§‹å·²æ”¯æ´ Walk Forwardï¼Œåªéœ€å¯¦ä½œï¼š
1. æ»‘å‹•çª—å£æ•¸æ“šåˆ‡åˆ†
2. å¢žé‡è¨“ç·´é‚è¼¯
3. å¤šçª—å£çµ±è¨ˆè¿½è¹¤

é…ç½®å·²åœ¨ `WALK_FORWARD_CONFIG` ä¸­é ç•™ã€‚

## ä½¿ç”¨å»ºè­°

1. **é¦–æ¬¡è¨“ç·´**ï¼šä½¿ç”¨è¼ƒå°‘ episodesï¼ˆä¾‹å¦‚ 20ï¼‰æ¸¬è©¦æµç¨‹
2. **èª¿æ•´åƒæ•¸**ï¼šæ ¹æ“šåˆæ­¥çµæžœèª¿æ•´çŽå‹µå‡½æ•¸å’Œè¶…åƒæ•¸
3. **å®Œæ•´è¨“ç·´**ï¼šè¨­å®š 100+ episodes é€²è¡Œå®Œæ•´è¨“ç·´
4. **ç›£æŽ§éŽæ“¬åˆ**ï¼šé—œæ³¨è¨“ç·´/é©—è­‰æ”¶ç›ŠçŽ‡å·®è·
5. **æ¸¬è©¦è©•ä¼°**ï¼šä½¿ç”¨æ¸¬è©¦é›†è©•ä¼°æœ€çµ‚æ¨¡åž‹

## æ•…éšœæŽ’é™¤

### GPU ç›¸é—œå•é¡Œ

#### GPU ä¸å¯ç”¨éŒ¯èª¤
```
RuntimeError: å¼·åˆ¶ä½¿ç”¨ CUDA ä½† GPU ä¸å¯ç”¨ï¼
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. **æª¢æŸ¥ PyTorch ç‰ˆæœ¬**ï¼š
   ```bash
   python -c "import torch; print(torch.cuda.is_available())"
   ```
   å¦‚æžœè¿”å›ž `False`ï¼Œéœ€è¦å®‰è£ CUDA ç‰ˆæœ¬çš„ PyTorch

2. **å®‰è£ CUDA ç‰ˆæœ¬çš„ PyTorch**ï¼š
   ```bash
   # è¨ªå• https://pytorch.org/ é¸æ“‡å°æ‡‰ç‰ˆæœ¬
   # ä¾‹å¦‚ CUDA 11.8:
   pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
   ```

3. **è‡¨æ™‚ä½¿ç”¨ CPU è¨“ç·´**ï¼š
   åœ¨ `config.py` ä¸­è¨­ç½®ï¼š
   ```python
   TRAIN_CONFIG['force_cuda'] = False
   TRAIN_CONFIG['device'] = 'cpu'
   ```

#### GPU è¨˜æ†¶é«”ä¸è¶³ (OOM)
```
RuntimeError: CUDA out of memory
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
- æ¸›å°‘ `batch_size`ï¼ˆä¾‹å¦‚å¾ž 256 é™åˆ° 128 æˆ– 64ï¼‰
- æ¸›å°‘ `replay_buffer_size`
- é—œé–‰å…¶ä»–ä½”ç”¨ GPU çš„ç¨‹åº

#### è¨“ç·´é€Ÿåº¦æ…¢
- ç¢ºèªä½¿ç”¨ GPUï¼šè¨“ç·´é–‹å§‹æ™‚æª¢æŸ¥ `âœ… ä½¿ç”¨è¨­å‚™: cuda:0`
- GPU è¨“ç·´æ‡‰æ¯” CPU å¿« 10-100 å€
- æª¢æŸ¥è³‡æ–™å‚³è¼¸ç“¶é ¸ï¼ˆç¢ºä¿è³‡æ–™åœ¨ GPU ä¸Šè™•ç†ï¼‰

### è¨“ç·´æ”¶ç›ŠçŽ‡ç‚ºè² 
- æª¢æŸ¥çŽå‹µå‡½æ•¸è¨­è¨ˆ
- å¢žåŠ  start_steps è®“ agent å……åˆ†æŽ¢ç´¢
- èª¿æ•´ SAC è¶…åƒæ•¸ï¼ˆalpha, gammaï¼‰

### Replay Buffer ä¸å¢žé•·
- æª¢æŸ¥ç¶“é©—å­˜å„²é‚è¼¯
- ç¢ºèª TrainingStrategy.next() æ­£å¸¸åŸ·è¡Œ

### é©—è­‰æ”¶ç›ŠçŽ‡ä¸ç©©å®š
- å¢žåŠ é©—è­‰é›†å¤§å°
- ä½¿ç”¨æ›´é•·çš„è¨“ç·´çª—å£
- è€ƒæ…®åŠ å…¥æ­£å‰‡åŒ–

---

**è¨“ç·´æ„‰å¿«ï¼** ðŸš€
